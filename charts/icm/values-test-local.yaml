test:
  enabled: true

icm-as:
  image:
    repository: "${ICM_TEST_IMAGE}"
  podSecurityContext:
    runAsUser: 0
  customCommand:
  - "/bin/sh"
  - "-c"
  - |
    set -x
    mkdir -p $HELM_DIRECTORY/server-logs
    chown -R ${SERVER_DIRECTORY_USER}:${SERVER_DIRECTORY_GROUP} ${HELM_DIRECTORY}/server-logs
    ls -la $HELM_DIRECTORY
    SITES_DIR=${WORKSPACE_DIRECTORY}/../../../sites
    SITES_VOL=/intershop
    cp -r \$SITES_DIR \$SITES_VOL
    chown -R ${SERVER_DIRECTORY_USER}:${SERVER_DIRECTORY_USER} \$SITES_VOL/sites
    find \$SITES_VOL -type f \> \"${RESULT_DIRECTORY}/sites.txt\"

    cat << 'EOF' > ./start_appserver.sh
      #!/bin/bash
      sh /intershop/bin/intershop.sh appserver
    EOF
    chmod +x ./start_appserver.sh
    timestamp=\$(date '+%Y-%m-%d_%H_%M_%S')
    sh ./start_appserver.sh 2>&1 | tee outfile $HELM_DIRECTORY/server-logs/as\${timestamp}.log
  license:
    type: secret
    secret:
      name: intershop-license
  nodeSelector: []
  persistence:
    sites:
      size: 1Gi
      type: local
      local:
        path: /run/desktop/mnt/host/d/tmp/pv/sites
    customdata:
      enabled: true
      existingClaim: ${HELM_JOB_NAME}-local-testdata-pvc
      mountPoint: /data
  environment:
    CARTRIDGE_LIST: "ft_e2e_test"

    SERVER_DIRECTORY: "${SERVER_DIRECTORY}"
    HELM_DIRECTORY: "${HELM_DIRECTORY}"
    CONFIG_DIRECTORY: "${CONFIG_DIRECTORY}"
    RESULT_DIRECTORY: "${RESULT_DIRECTORY}"
    WORKSPACE_DIRECTORY: "${WORKSPACE_DIRECTORY}"
    SERVER_DIRECTORY_GROUP: "${SERVER_DIRECTORY_GROUP}"
    SERVER_DIRECTORY_USER: "${SERVER_DIRECTORY_USER}"

    INTERSHOP_SMTPSERVER: "${HELM_JOB_NAME}-icm-mail" # adapt when service for mail is created
    INTERSHOP_WEBSERVERURL: "http://${HELM_JOB_NAME}-icm-web-wa:8080"
    INTERSHOP_WEBSERVERSECUREURL: "https://${HELM_JOB_NAME}-icm-web-wa:8443"

    # Disable Mailhog for now (#82978)
    MAIL_SMTP_MAILHOG_ENABLED: "false"
  datadog:
    enabled: false
    env: eng-iste-testrun
    options: "-Ddd.profiling.enabled=false -Ddd.trace.analytics.enabled=true -Ddd.jdbc.analytics.enabled=true"
  mssql:
    enabled: true
    acceptEula: "Y"
    persistence:
      data:
        size: 1Gi
        type: local
        local:
          path: /run/desktop/mnt/host/d/tmp/pv/mssql/data
      backup:
        size: 1Gi
        type: local
        local:
          path: /run/desktop/mnt/host/d/tmp/pv/mssql/backup

icm-web:
  webadapter:
    image:
      repository: "${ICM_WEBSERVER_IMAGE}"
  agent:
    image:
      repository: "${ICM_WEBADAPTER_AGENT_IMAGE}"
  nodeSelector: []
  persistence:
    pagecache:
      size: 1Gi
      type: local
      local:
        path: /run/desktop/mnt/host/d/tmp/pv/pagecache
    customdata:
      enabled: false
  environment:
    REQUESTLOG_ENABLED: false
    HELM_DIRECTORY: "${HELM_DIRECTORY}"
  service:
    httpPort: 8080
    httpsPort: 8443

mail:
  image:
    repository: ishisteacr.azurecr.io/iste/iste-mail:1.0.0-SNAPSHOT
  environment:
    HELM_DIRECTORY: "${HELM_DIRECTORY}"

testrunner:
  image:
    repository: "${ICM_TEST_IMAGE}"
    pullPolicy: Always
    command: |
      mkdir -p ${RESULT_DIRECTORY}

      # startup
      sh /intershop/bin/testrunner.sh -s=${TESTSUITE} -o=${RESULT_DIRECTORY} 2>&1 | tee -a ${RESULT_DIRECTORY}/istestrunner_log.txt
      PROCESS_ERROR_LEVEL=\$?
      TEST_EXECUTION_RESULT_STATUS="failed"
      [ \${PROCESS_ERROR_LEVEL} = 0 ] && TEST_EXECUTION_RESULT_STATUS="success"
      [ \${PROCESS_ERROR_LEVEL} = 1 ] && top -b -n 1 > ${RESULT_DIRECTORY}/top.txt
      echo "result: \${TEST_EXECUTION_RESULT_STATUS}" > ${RESULT_DIRECTORY}/finished.yml
      echo "result-datetime: $(date)" >> ${RESULT_DIRECTORY}/finished.yml

      exit $PROCESS_ERROR_LEVEL
  imagePullSecrets:
  - "icmbuildsnapshot"
  podSecurityContext:
    runAsUser: 0
  environment:
    CARTRIDGE_LIST: "app_bo_test"

    RESULT_DIRECTORY: "${RESULT_DIRECTORY}"

    MAIL_SERVER: "${HELM_JOB_NAME}-mail"

    TESTSUITE: "${TESTSUITE}"
    HOST: "${HELM_JOB_NAME}-icm-web-wa"

    APPSERVERNAME: "${HELM_JOB_NAME}-icm-as"
    MAIL_SHARE: "${HELM_DIRECTORY}/test-mails"

    PORT_HTTP: 8080
    PORT_HTTPS: 8443
    SERVLETENGINE_PORT: 7743

    #DEFAULT_PAGEDUMP_DIRECTORY: ${STACK_DIRECTORY}/pagedumps
    REMOVE_SUCCESSFUL_PAGEDUMPS: 'true'
  resources:
    requests:
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 1000m
      memory: 2Gi
  initContainer:
    resources:
      requests:
        cpu: 1000m
        memory: 2Gi
      limits:
        cpu: 1000m
        memory: 2Gi
  replicaCount: 1
  nodeSelector: []
  persistence:
    testdata:
      size: 1Gi
      type: local
      local:
        dir: /run/desktop/mnt/host/d/tmp/pv/testdata

  ## Control options regarding the java-vm running the ICM-AS
  jvm:
    # define options / parameters to be used to start the jvm
    options:
    # define additional options / parameters to be used to start the jvm (will be appended to options)
    additionalOptions:

  datadog:
    enabled: false
    env: eng-iste-testrun
    options: "-Ddd.profiling.enabled=false -Ddd.trace.analytics.enabled=true -Ddd.jdbc.analytics.enabled=true"
