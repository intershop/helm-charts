suite: tests correctness of keyvault serviceaccount configuration
templates:
  - templates/keyvault-serviceaccount.yaml

tests:
- it: should create a ServiceAccount when keyvault is enabled
  values:
  - ../values.yaml
  # use a separate values-yaml because setting array values directly does not work
  - values/keyvault.yaml
  asserts:
  - hasDocuments:
      count: 1
  - equal:
      path: metadata.name
      value: RELEASE-NAME-keyvault-serviceaccount
  - equal:
      path: metadata.annotations["azure.workload.identity/client-id"]
      value: test-client-id
  - equal:
      path: metadata.labels["secret-store"]
      value: test-keyvault

- it: should not create a ServiceAccount when keyvault is disabled
  set:
    keyvault:
      enabled: false
  asserts:
    - hasDocuments:
        count: 0