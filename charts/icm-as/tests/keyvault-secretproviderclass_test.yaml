suite: tests correctness of keyvault service provider class configuration
templates:
  - templates/keyvault-secretproviderclass.yaml

tests:
- it: should create a SecretProviderClass when keyvault is enabled
  values:
  - ../values.yaml
  # use a separate values-yaml because setting array values directly does not work
  - values/keyvault.yaml
  asserts:
  - hasDocuments:
      count: 1
  - equal:
      path: metadata.name
      value: RELEASE-NAME-keyvault-secretproviderclass
  - equal:
      path: spec.provider
      value: azure
  - equal:
      path: spec.parameters.userAssignedIdentityID
      value: test-client-id
  - equal:
      path: spec.parameters.keyvaultName
      value: test-keyvault
  - matchRegex:
      path: spec.parameters.objects
      pattern: "objectName: test-secret-obj"

  - matchRegex:
      path: spec.parameters.objects
      pattern: "objectName: test-cert-name"

  - equal:
      path: spec.secretObjects[0].data[0].objectName
      value: "test-secret-obj"
  - equal:
      path: spec.secretObjects[0].data[0].key
      value: "test-secret-key"

  - equal:
      path: spec.secretObjects[1].data[0].objectName
      value: "test-cert-name"
  - equal:
      path: spec.secretObjects[1].data[0].key
      value: "tls.key"
  - equal:
      path: spec.secretObjects[1].data[1].objectName
      value: "test-cert-name"
  - equal:
      path: spec.secretObjects[1].data[1].key
      value: "tls.crt"

  - equal:
      path: spec.secretObjects[2].data[0].objectName
      value: "test-key-obj"
  - equal:
      path: spec.secretObjects[2].data[0].key
      value: "test-key-name"

- it: should not create a SecretProviderClass when keyvault is disabled
  set:
    keyvault:
      enabled: false
  asserts:
    - hasDocuments:
        count: 0