suite: tests correctness of serviceAccount and workloadIdentity configuration
templates:
  - templates/serviceaccount.yaml
  - templates/as-deployment.yaml
  - templates/jobserver-deployment.yaml
tests:
  # Test 1: Default configuration - no serviceAccount created
  - it: should not create serviceAccount when all features disabled
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    set:
      serviceAccount.create: false
      workloadIdentity.enabled: false
      jgroups.discovery: file_ping
      replicaCount: 1
      job.enabled: true
    asserts:
      - template: serviceaccount.yaml
        hasDocuments:
          count: 0
      - template: as-deployment.yaml
        notExists:
          path: spec.template.spec.serviceAccountName
      - template: as-deployment.yaml
        notExists:
          path: spec.template.metadata.labels["azure.workload.identity/use"]
      - template: jobserver-deployment.yaml
        notExists:
          path: spec.jobTemplate.spec.template.spec.serviceAccountName
      - template: jobserver-deployment.yaml
        notExists:
          path: spec.jobTemplate.spec.template.metadata.labels["azure.workload.identity/use"]

  # Test 2: ServiceAccount creation forced by serviceAccount.create=true
  - it: should create serviceAccount when serviceAccount.create is true
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: true
      workloadIdentity.enabled: false
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: icm-as-sa

  # Test 3: ServiceAccount with custom name
  - it: should use custom name when serviceAccount.name is provided
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: true
      serviceAccount.name: my-custom-sa
    asserts:
      - equal:
          path: metadata.name
          value: my-custom-sa

  # Test 4: ServiceAccount with custom labels
  - it: should apply custom labels to serviceAccount
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: true
      serviceAccount.labels.customLabel1: value1
      serviceAccount.labels.customLabel2: value2
    asserts:
      - equal:
          path: metadata.labels.customLabel1
          value: value1
      - equal:
          path: metadata.labels.customLabel2
          value: value2

  # Test 5: ServiceAccount with workload identity label
  - it: should have workload identity label when serviceAccount is created
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: true
    asserts:
      - equal:
          path: metadata.labels["intershop.workload.identity/use"]
          value: "true"

  # Test 6: Custom labels can overwrite workload identity label (merge behavior)
  - it: should allow custom labels to overwrite workload identity label when explicitly set
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: true
      serviceAccount.labels.customLabel: customValue
    asserts:
      - equal:
          path: metadata.labels["intershop.workload.identity/use"]
          value: "true"
      - equal:
          path: metadata.labels.customLabel
          value: customValue

  # Test 7: ServiceAccount created when workloadIdentity is enabled
  - it: should create serviceAccount when workloadIdentity is enabled
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: false
      workloadIdentity.enabled: true
      workloadIdentity.clientId: "12345678-90ab-cdef-1234-567890abcdef"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount

  # Test 8: WorkloadIdentity with clientId only
  - it: should add clientId annotation when workloadIdentity is enabled
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      workloadIdentity.enabled: true
      workloadIdentity.clientId: "abcdefgh-1234-5678-90ab-cdef12345678"
    asserts:
      - equal:
          path: metadata.annotations["azure.workload.identity/client-id"]
          value: "abcdefgh-1234-5678-90ab-cdef12345678"
      - notExists:
          path: metadata.annotations["azure.workload.identity/tenant-id"]

  # Test 9: WorkloadIdentity with clientId and tenantId
  - it: should add both clientId and tenantId annotations when both are provided
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      workloadIdentity.enabled: true
      workloadIdentity.clientId: "abcdefgh-1234-5678-90ab-cdef12345678"
      workloadIdentity.tenantId: "12345678-90ab-cdef-1234-567890abcdef"
    asserts:
      - equal:
          path: metadata.annotations["azure.workload.identity/client-id"]
          value: "abcdefgh-1234-5678-90ab-cdef12345678"
      - equal:
          path: metadata.annotations["azure.workload.identity/tenant-id"]
          value: "12345678-90ab-cdef-1234-567890abcdef"

  # Test 10: WorkloadIdentity without clientId should fail
  - it: should fail when workloadIdentity is enabled but clientId is missing
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      workloadIdentity.enabled: true
    asserts:
      - failedTemplate:
          errorMessage: "Error: missing value at workloadIdentity.clientId."

  # Test 11: Merge custom annotations with workloadIdentity annotations
  - it: should merge custom annotations with workloadIdentity annotations
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: true
      serviceAccount.annotations.customAnnotation: customValue
      workloadIdentity.enabled: true
      workloadIdentity.clientId: "abcdefgh-1234-5678-90ab-cdef12345678"
    asserts:
      - equal:
          path: metadata.annotations.customAnnotation
          value: customValue
      - equal:
          path: metadata.annotations["azure.workload.identity/client-id"]
          value: "abcdefgh-1234-5678-90ab-cdef12345678"

  # Test 12: Custom annotations merge with workloadIdentity annotations correctly
  - it: should merge both custom and workloadIdentity annotations without conflicts
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: true
      serviceAccount.annotations.customKey1: customValue1
      serviceAccount.annotations.customKey2: customValue2
      workloadIdentity.enabled: true
      workloadIdentity.clientId: "abcdefgh-1234-5678-90ab-cdef12345678"
      workloadIdentity.tenantId: "12345678-90ab-cdef-1234-567890abcdef"
    asserts:
      - equal:
          path: metadata.annotations.customKey1
          value: customValue1
      - equal:
          path: metadata.annotations.customKey2
          value: customValue2
      - equal:
          path: metadata.annotations["azure.workload.identity/client-id"]
          value: "abcdefgh-1234-5678-90ab-cdef12345678"
      - equal:
          path: metadata.annotations["azure.workload.identity/tenant-id"]
          value: "12345678-90ab-cdef-1234-567890abcdef"

  # Test 13: ServiceAccount created for jgroups kube_ping
  - it: should create serviceAccount when jgroups uses kube_ping
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: false
      workloadIdentity.enabled: false
      jgroups.discovery: kube_ping
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount

  # Test 14: ServiceAccountName in as-deployment when serviceAccount is enabled
  - it: should set serviceAccountName in as-deployment when serviceAccount is enabled
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: as-deployment.yaml
    set:
      serviceAccount.create: true
      replicaCount: 1
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: icm-as-sa

  # Test 15: Custom serviceAccountName in as-deployment
  - it: should use custom serviceAccountName in as-deployment
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: as-deployment.yaml
    set:
      serviceAccount.create: true
      serviceAccount.name: my-custom-sa
      replicaCount: 1
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: my-custom-sa

  # Test 16: Pod labels for workloadIdentity in as-deployment
  - it: should add workload identity pod label in as-deployment when serviceAccount is enabled
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: as-deployment.yaml
    set:
      serviceAccount.create: true
      replicaCount: 1
    asserts:
      - equal:
          path: spec.template.metadata.labels["azure.workload.identity/use"]
          value: "true"

  # Test 17: No serviceAccountName when serviceAccount is disabled
  - it: should not set serviceAccountName in as-deployment when serviceAccount is disabled
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: as-deployment.yaml
    set:
      serviceAccount.create: false
      workloadIdentity.enabled: false
      jgroups.discovery: file_ping
      replicaCount: 1
    asserts:
      - notExists:
          path: spec.template.spec.serviceAccountName

  # Test 19: ServiceAccountName in jobserver-deployment when enabled
  - it: should set serviceAccountName in jobserver-deployment when serviceAccount is enabled
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: jobserver-deployment.yaml
    set:
      serviceAccount.create: true
      job.enabled: true
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.spec.serviceAccountName
          value: icm-as-sa

  # Test 20: Pod labels in jobserver-deployment
  - it: should add workload identity pod label in jobserver-deployment when serviceAccount is enabled
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: jobserver-deployment.yaml
    set:
      serviceAccount.create: true
      job.enabled: true
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.metadata.labels["azure.workload.identity/use"]
          value: "true"

  # Test 21: Combined scenario - serviceAccount.create and workloadIdentity both enabled
  - it: should work correctly when both serviceAccount.create and workloadIdentity are enabled
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: true
      serviceAccount.name: combined-sa
      serviceAccount.labels.customLabel: customValue
      serviceAccount.annotations.customAnnotation: customValue
      workloadIdentity.enabled: true
      workloadIdentity.clientId: "abcdefgh-1234-5678-90ab-cdef12345678"
      workloadIdentity.tenantId: "12345678-90ab-cdef-1234-567890abcdef"
    asserts:
      - equal:
          path: metadata.name
          value: combined-sa
      - equal:
          path: metadata.labels.customLabel
          value: customValue
      - equal:
          path: metadata.labels["intershop.workload.identity/use"]
          value: "true"
      - equal:
          path: metadata.annotations.customAnnotation
          value: customValue
      - equal:
          path: metadata.annotations["azure.workload.identity/client-id"]
          value: "abcdefgh-1234-5678-90ab-cdef12345678"
      - equal:
          path: metadata.annotations["azure.workload.identity/tenant-id"]
          value: "12345678-90ab-cdef-1234-567890abcdef"

  # Test 22: Combined scenario with all three triggers (create, workloadIdentity, kube_ping)
  - it: should create serviceAccount when any trigger is active
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: false
      workloadIdentity.enabled: false
      jgroups.discovery: kube_ping
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount

  # Test 23: Annotations only present when workloadIdentity is enabled
  - it: should not have annotations section when workloadIdentity is disabled and no custom annotations
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: true
      workloadIdentity.enabled: false
    asserts:
      - notExists:
          path: metadata.annotations

  # Test 24: Full name generation default
  - it: should generate default serviceAccount name based on fullname
    release:
      name: my-release
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: true
    asserts:
      - equal:
          path: metadata.name
          value: my-release-icm-as-sa

  # Test 25: Full name with fullnameOverride
  - it: should use fullnameOverride for serviceAccount name generation
    release:
      name: icm-as
    chart:
      version: 0.8.15
    values:
      - ../values.yaml
    template: serviceaccount.yaml
    set:
      serviceAccount.create: true
      fullnameOverride: my-override
    asserts:
      - equal:
          path: metadata.name
          value: my-override-sa
