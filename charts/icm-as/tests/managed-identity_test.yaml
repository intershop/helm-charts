suite: test managed identity configuration
templates:
  - as-deployment.yaml
  - jobserver-deployment.yaml
  - serviceaccount.yaml
tests:
  - it: should create service account when managed identity is enabled
    set:
      managedIdentity.enabled: true
      managedIdentity.clientId: "test-client-id"
      managedIdentity.tenantId: "test-tenant-id"
    asserts:
      - containsDocument:
          kind: ServiceAccount
          apiVersion: v1
      - equal:
          path: metadata.annotations["azure.workload.identity/client-id"]
          value: "test-client-id"
      - equal:
          path: metadata.annotations["azure.workload.identity/tenant-id"]
          value: "test-tenant-id"

  - it: should add workload identity annotations to deployment when enabled
    set:
      managedIdentity.enabled: true
      managedIdentity.clientId: "test-client-id"
      replicaCount: 1
    template: as-deployment.yaml
    asserts:
      - equal:
          path: spec.template.metadata.annotations["azure.workload.identity/use"]
          value: "true"
      - equal:
          path: spec.template.metadata.annotations["azure.workload.identity/client-id"]
          value: "test-client-id"
      - equal:
          path: spec.template.metadata.labels["azure.workload.identity/use"]
          value: "true"

  - it: should add managed identity environment variables when enabled
    set:
      managedIdentity.enabled: true
      managedIdentity.clientId: "test-client-id"
      managedIdentity.tenantId: "test-tenant-id"
      replicaCount: 1
    template: as-deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: AZURE_CLIENT_ID
            value: "test-client-id"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: AZURE_TENANT_ID
            value: "test-tenant-id"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: AZURE_FEDERATED_TOKEN_FILE
            value: "/var/run/secrets/azure/tokens/azure-identity-token"

  - it: should add azure identity token volume when managed identity is enabled
    set:
      managedIdentity.enabled: true
      managedIdentity.clientId: "test-client-id"
      replicaCount: 1
    template: as-deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: azure-identity-token
            projected:
              defaultMode: 420
              sources:
                - serviceAccountToken:
                    audience: api://AzureADTokenExchange
                    expirationSeconds: 3600
                    path: azure-identity-token

  - it: should add azure identity token volume mount when managed identity is enabled
    set:
      managedIdentity.enabled: true
      managedIdentity.clientId: "test-client-id"
      replicaCount: 1
    template: as-deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: azure-identity-token
            mountPath: /var/run/secrets/azure/tokens
            readOnly: true

  - it: should set service account name when managed identity is enabled
    set:
      managedIdentity.enabled: true
      managedIdentity.clientId: "test-client-id"
      replicaCount: 1
    template: as-deployment.yaml
    asserts:
      - isNotEmpty:
          path: spec.template.spec.serviceAccountName

  - it: should not add managed identity features when disabled
    set:
      managedIdentity.enabled: false
      replicaCount: 1
    template: as-deployment.yaml
    asserts:
      - isNull:
          path: spec.template.metadata.annotations["azure.workload.identity/use"]
      - isNull:
          path: spec.template.metadata.labels["azure.workload.identity/use"]
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: AZURE_CLIENT_ID
