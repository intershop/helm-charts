{{- if eq (include "icm-as.serviceAccount.enabled" .) "true" -}}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "icm-as.serviceAccount.name" . }}
  labels:
    {{ include "icm-as.labels" . | indent 4 | trim }}
    {{- $labels := dict "intershop.workload.identity/use" "true" }}
    {{- $customLabels := default dict .Values.serviceAccount.labels }}
    {{- $mergedLabels := merge $customLabels $labels }}{{/* $customLabels overwrite $labels */}}
    {{- toYaml $mergedLabels | nindent 4 }}

  {{- $annotations := dict }}
  {{- if .Values.workloadIdentity.enabled }}
    {{- if .Values.workloadIdentity.clientId }}
      {{- $_ := set $annotations "azure.workload.identity/client-id" .Values.workloadIdentity.clientId }}
    {{- else }}
      {{- fail "Error: missing value at workloadIdentity.clientId." }}
    {{- end }}
    {{- if .Values.workloadIdentity.tenantId }}
      {{- $_ := set $annotations "azure.workload.identity/tenant-id" .Values.workloadIdentity.tenantId }}
    {{- end }}
  {{- end }}{{/* if .Values.workloadIdentity.enabled */}}
  {{- $customAnnotations := default dict .Values.serviceAccount.annotations }}
  {{- $mergedAnnotations := merge $customAnnotations $annotations }}{{/* $customAnnotations overwrite $annotations */}}
  {{- if not (empty $mergedAnnotations) }}
  annotations:
    {{- toYaml $mergedAnnotations | nindent 4 }}
  {{- end }}
{{- end -}}
